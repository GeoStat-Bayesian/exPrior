---
title: "Data Assimilation with {rPrior}"
subtitle: "A Simple Example"
author: "Karina Cucchi and Nura Kawa"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

The purpose of the package `{rPrior}` is to provide methods for data assimilation via the computation of regionalized priors, which is introduced in Cucchi et al 2017. Here we present a simple example of data assimilation, where we use the function **generalFromMeas()** to build the models, as well as two `{rPrior}` fuctions to visualize the regionalized prior and the model hyperparameters. 

## A Hierarchical Model for Data Assimilation

Hydrogeologists often must create predictive models of hydrogeological sites where no little to samples have been taken. One method is *Data Assimilation*, which refers to the process of using measurements from sites similar to the target site, called *ex-situ* data, to buid probability density functions of parameters of the target site. In a Bayesian framework this is to compute an *informative prior* using ex-situ data. Here we present a simple example of this, where the goal is to derive the regionalized prior distribution at target site s using a synthetic dataset relating to porous media porosity from three sites: a, b, and c. The target variable $Y$ is porosity. The regionalized prior of interest is $p(Y|\mathcal{D})$, where $Y$ is the random variable for porosity and $\mathcal{D}$ is the ex-situ data used in the assimilation. Here the data $\mathcal{D}={y_{i,j}}$, where $y_{i,j}$ is the parameter measurement $j$ at similar site $i$.


```{include=FALSE, echo=FALSE}
Mathematically, the model is defined as such:

$$    y_{i,j} \sim N(\mu_i,\sigma^2) \\$$
$$    \mu_i \sim N(\alpha,\tau)$$
$$\eta = (\alpha, \tau, \sigma)$$


Where $\mu_i$ is the site-specific mean at site $i$, $\sigma^2$ represents within-site variability and $\tau^2$ represents inter-site variability, and $\eta$ are the hyperparameters of the model.
```

### We build the following Bayesian model with three levels:   
1. The first level contains measurements from each site.  
2. In the second level, $y_j$ is a realization of the Gaussian distribution with mean $\mu_j$ and variance $\sigma^2_j$.
3. In the third level, $\mu_j$ is a realization of Gaussian distribution with parameter $\alpha$ and $\tau$, defining a common prior pdf for the error variance $\sigma^2$.   

Mathematically, the model is defined as such:

$$y_{i,j} \sim N(\mu_i,\sigma^2)$$
$$\mu_i \sim N(\alpha,\tau)$$

Where $\mu_i$ is the site-specific mean at site $i$, $\sigma^2$ represents within-site variability and $\tau^2$ represents inter-site variability, and hyperparameters $\eta$ are $(\alpha, \tau, \text{and } \sigma)$.  

#### Accounting for Spatial Correlation in Measurements

The function **generalFromMeas()** allows a user to build multivariate models that take into account spatial variability between measurements. This multivariate model is explained in the R Journal paper (reference) and Cucchi 2017 (reference). 

### Ex-situ Data    
To build the model for s, we use the following ex-situ data from sites a, b, and c:    
  
*  site a has one estimate of $Y_a$, with value 2.  
*  site b has three measurements of $Y_b$: $y_{b,1} = 3, y_{b,2} = 4$ and $y_{b,3} = 2$.  
*  site c also has three measurements: $y_{c,1} = 3, y_{c,2} = 3$ and $y_{c,3} = 2$.   

In this example we do not include spatial coordinates for these measurements; however, these can be added to the data frame below with column names "x" and "y". 

```{r data, message=FALSE, warning=FALSE}
# data frame of measurements
df_meas <- data.frame(val=c(c(2),c(3, 4, 2),c(3, 3, 2)),
                     site_id=c(rep("a",1),rep("b",3),rep("c",3)))

head(df_meas)
```


To compute the prior, first install rPrior:  

### Installing rPrior

```{r install rPrior, message=FALSE, warning=FALSE}

# if devtools is not installed: install.packages("devtools")
if (!("devtools" %in% rownames(installed.packages()))){
  install.packages("devtools")}


if (!("rPrior" %in% rownames(installed.packages()))){
  devtools::install_github("kcucchi/rPrior")}

require(rPrior)
```

### Function **generalFromMeas()**

We use the function `generalFromMeas()` to compute both regionalized prior distribution and uninformative prior for a parameter $y$, and prior and posterior hyperparameters of this Bayesian hierarchical model. The function to use is **generalFromMeas()**, which has three main required arguments:  

*  `meas`:  a dataframe containing measurements to assimilate, with fields val and site_id  
*  `eval_theta`:  a vector of numerical values of informative prior evaluation points   
* `spatialCoordinates`: a boolean specifying whether spatial coordinates are provided as covariates to numerical measurements. If `TRUE`, the spatial autocorrelation of measurements is accounted for, assuming that the spatial covariance has an exponential form.

The remaining arguments of the function are optional, and details can be seen by typing `?generalFromMeas` into the Console. To build a model, simply follow the code below:  

```{r build-prior, eval=FALSE}

theta_vect <- seq(from=-10,to=10,by=0.1) # at which values do we evaluate the prior?

# prior
regionalized_prior <- generalFromMeas(meas=df_meas,
                                      eval_theta=theta_vect,
                                      spatialCoordinates = FALSE)
```


The model takes several minutes to run, and its run time is a function of both the number of sites in `meas` and the number of measurements per site (note: in this vignette we have included the output as an R object, "regionalized_prior.RData"). The output is PDF evaluated at values corresponding to `theta`. The output is a list that contains the following fields:  

* `rPrior`: the regionalized prior   
*  `uPrior`: the uninformed prior (more information, ask Karina)
*  `d_hyperPar`: data frames containing the distributions of the model hyperparameters  
* `meas`: the input dataframe of measurements into the function  
* `MCMC`: output from the MCMC compiler of NIMBLE  


## Plotting Resuts with **plot_rPrior()** and **plot_hyperDist()**  

`{rPrior}` contains the function `plot_rPrior()`, which takes as an argument the output of `generalFromMeas()` and plots the regionalized and non-regionalized priors:

```{r, echo=FALSE}
load("../data/regionalized_prior.RData")
```


```{r, warning=FALSE, message=FALSE, fig.width=7.2, fig.height=5, fig.align='center'}
plot_rPrior(regionalized_prior)
```

Here, $f(Y|D)$ is the regionalized prior that estimates the distribution of parameter $Y$ given the data $D$. $f(Y)$ is the uninformed prior, which is flat. 

### Plot of the hyperparameters $\alpha$, $\sigma$ and $\tau$: 

`{rPrior}` also contains the function `plot_hyerDist()`, which takes as an argument the output of `generalFromMeas()` and plots the informative and non-informative distributions of the model hyperparameters:


```{r load for now, echo=FALSE}
load("../data/regionalized_prior.RData")
```


```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=5, fig.align='center'}
plot_hyperDist(regionalized_prior)
```

For each paramater we have $f(Y|\eta)$ is the regionalized prior that estimates the distribution of hyperparameter $\eta$ given the data $D$ (blue). $f(\eta)$ is the uninformed prior (black). 

## Conclusion  

This vignette has briefly discussed the data assimilation framework and explained how the function **generalFromMeas()** can assimilate data into regionalized priors. The function builds a three-level Bayesian Hierarchical Model in its default settings. If a user wishes to provide spatial coordinates, the function builds a multivariate model. Finally, the output of **generalFromMeas()** can be quickly plotted using functions **plot_rPrior()** and **plot_hyperDist()**. 
